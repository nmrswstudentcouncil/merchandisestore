<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô - NMRSW Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800&family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://img5.pic.in.th/file/secure-sv1/happynewyear.png">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { 
            --primary: #C41E3A; 
            --primary-light: #FFF1F2;
            --primary-dark: #9B1C31;
            --surface: #FFFFFF; 
            --background: #F8FAFC; 
            --text-main: #0F172A; 
            --text-sec: #64748B;
            --border: #E2E8F0;
            --radius-xl: 32px;
            --radius-lg: 20px;
            --radius-md: 12px;
            --shadow-soft: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
        }
        
        body { 
            font-family: 'Sarabun', sans-serif; 
            color: var(--text-main); 
            background: var(--background); 
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .main-wrapper { 
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 30px;
            align-items: start;
        }

        /* --- ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: Product Showcase --- */
        .left-panel {
            background: var(--surface);
            border-radius: var(--radius-xl);
            padding: 40px;
            box-shadow: var(--shadow-soft);
        }

        .btn-back { 
            display: inline-flex; 
            align-items: center; 
            color: var(--text-sec); 
            text-decoration: none; 
            font-weight: 600; 
            font-size: 0.9rem; 
            margin-bottom: 2rem; 
            transition: all 0.3s ease;
            padding: 10px 20px;
            background: #f1f5f9;
            border-radius: 50px;
        }
        .btn-back:hover { 
            color: var(--primary); 
            background: var(--primary-light); 
            transform: translateX(-5px); 
        }
        
        .main-product-title {
            font-family: 'Kanit', sans-serif;
            font-size: clamp(2rem, 5vw, 2.8rem);
            font-weight: 800;
            line-height: 1.1;
            margin-bottom: 1.5rem;
            letter-spacing: -1px;
        }

        .main-img-box {
            width: 100%;
            aspect-ratio: 1/1;
            background: radial-gradient(circle, #ffffff 0%, #f1f5f9 100%);
            border-radius: var(--radius-lg);
            display: flex; 
            align-items: center; 
            justify-content: center;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }
        .main-img-box img { 
            max-width: 80%; 
            max-height: 80%; 
            object-fit: contain; 
            filter: drop-shadow(0 20px 40px rgba(0,0,0,0.1));
            transition: transform 0.5s ease;
        }
        .main-img-box:hover img { transform: scale(1.05); }

        .specs-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); 
            gap: 12px;
            margin-top: 2rem;
        }
        .spec-item { 
            padding: 12px; 
            background: #f8fafc; 
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 0.85rem;
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }

        /* --- ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: Payment Card --- */
        .right-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            padding: 32px;
            box-shadow: var(--shadow-soft);
            border: 1px solid white;
            position: sticky;
            top: 20px;
        }

        .step-indicator { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; padding: 0 10px; }
        .step-line { position: absolute; top: 18px; left: 10%; width: 80%; height: 2px; background: var(--border); z-index: 1; }
        .step { 
            width: 36px; height: 36px; border-radius: 50%; background: white; border: 2px solid var(--border);
            display: flex; align-items: center; justify-content: center; font-weight: 800;
            z-index: 2; transition: 0.4s; color: var(--text-sec); font-family: 'Kanit'; font-size: 0.9rem;
        }
        .step.active { 
            background: var(--primary); border-color: var(--primary); color: white; 
            box-shadow: 0 0 15px rgba(196, 30, 58, 0.2); 
        }

        .summary-card {
            background: #1e293b; color: white;
            padding: 24px; border-radius: var(--radius-lg); margin-bottom: 24px;
        }
        .price-label { font-size: 0.85rem; opacity: 0.7; margin-bottom: 4px; }
        .price-val { font-family: 'Kanit'; font-size: 2.2rem; font-weight: 800; color: #fff; }

        .qty-selector { 
            background: rgba(255,255,255,0.08); 
            padding: 12px 16px; 
            border-radius: 12px; 
            margin-top: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .qty-btn { 
            background: white; border: none; width: 32px; height: 32px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.1rem;
            transition: 0.2s;
        }
        .qty-btn:hover { background: var(--primary-light); color: var(--primary); }

        .section-title { font-family: 'Kanit'; font-weight: 700; font-size: 1rem; margin-bottom: 12px; margin-top: 24px; color: var(--text-main); }
        
        .custom-input {
            width: 100%; padding: 12px 16px; border: 1.5px solid var(--border); border-radius: 12px;
            font-size: 1rem; transition: 0.3s; margin-bottom: 10px; font-family: 'Sarabun';
        }
        .custom-input:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 4px var(--primary-light); }

        .pay-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .pay-item {
            border: 1.5px solid var(--border); padding: 12px; border-radius: 12px;
            text-align: center; cursor: pointer; transition: 0.2s; background: white;
        }
        .pay-item.selected { border-color: var(--primary); background: var(--primary-light); }
        .pay-item .icon { font-size: 1.5rem; margin-bottom: 4px; }
        .pay-item .label { font-size: 0.8rem; font-weight: 700; }

        .upload-zone {
            margin-top: 15px; padding: 20px; border: 2px dashed var(--border);
            border-radius: 12px; text-align: center; background: #fcfcfc;
        }

        .checkout-btn {
            width: 100%; padding: 1rem; background: var(--primary); color: white;
            border: none; border-radius: 14px; font-family: 'Kanit'; font-size: 1.1rem;
            font-weight: 700; margin-top: 24px; cursor: pointer; transition: 0.3s;
        }
        .checkout-btn:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-2px); }
        .checkout-btn:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }

        /* Mobile Adjustments */
        @media (max-width: 992px) {
            .main-wrapper { grid-template-columns: 1fr; }
            .container { padding: 20px 15px; }
            .left-panel { padding: 24px; }
            .right-panel { position: static; padding: 24px; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="main-wrapper">
            <div class="left-panel">
                <a href="index.html" class="btn-back">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤
                </a>
                
                <h1 class="main-product-title" id="mainProdTitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤...</h1>
                
                <div class="main-img-box" id="imgContainer">
                    <div style="font-size: 5rem;">üì¶</div>
                </div>

                <div class="details-section">
                    <h2 style="font-family: 'Kanit'; font-size: 1.4rem; margin-bottom: 12px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                    <p style="color: var(--text-sec); font-size: 1rem; margin-bottom: 20px;"id="prodcomment"></p>
                    
                </div>
            </div>

            <div class="right-panel">
                <div class="step-indicator">
                    <div class="step-line"></div>
                    <div class="step active" id="st1">1</div>
                    <div class="step" id="st2">2</div>
                    <div class="step" id="st3">3</div>
                </div>

                <div class="summary-card">
                    <div class="price-label">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <div class="price-val" id="prodPrice">‡∏ø0</div>
                    
                    <div class="qty-selector">
                        <span style="font-size: 0.9rem; font-weight: 500;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <button class="qty-btn" onclick="adjustQty(-1)">‚àí</button>
                            <span id="quantityDisplay" style="font-family: 'Kanit'; font-weight: 700; font-size: 1.1rem;">1</span>
                            <button class="qty-btn" onclick="adjustQty(1)">+</button>
                        </div>
                    </div>
                </div>

                <div class="section-title">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="firstName" class="custom-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á" oninput="checkReady()">
                    <input type="text" id="lastName" class="custom-input" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" oninput="checkReady()">
                </div>
                <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 10px;">
                    <input type="text" id="stdClass" class="custom-input" placeholder="‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏°.5/12)" oninput="checkReady()">
                    <input type="number" id="stdNo" class="custom-input" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" oninput="checkReady()">
                </div>
                <input type="number" id="stdId" min="5" max="5" class="custom-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 5 ‡∏´‡∏•‡∏±‡∏Å" oninput="checkReady()">

                <div class="section-title">üí≥ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
                <div class="pay-grid">
                    <div class="pay-item" id="pay-qr" onclick="selectMethod('qrcode')">
                        <div class="icon">üì±</div>
                        <div class="label">QR PromptPay</div>
                    </div>
                    <div class="pay-item" id="pay-bank" onclick="selectMethod('banking')">
                        <div class="icon">üè¶</div>
                        <div class="label">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                    </div>
                </div>

                <div id="sec-qrcode" class="upload-zone" style="display: none;">
                    <img src="https://img5.pic.in.th/file/secure-sv1/611180469_884599267452953_5923060998778918454_n.jpg" style="width: 100%; max-width: 180px; border-radius: 12px; margin: 10px 0;">
                    <p style="font-size: 0.75rem; color: var(--text-sec); margin-bottom: 10px;">‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
                    <input type="file" id="slipQR" accept="image/*" onchange="checkReady()" style="font-size: 0.8rem; width: 100%;">
                </div>

                <div id="sec-banking" class="upload-zone" style="display: none;">
                    <div style="font-size: 0.85rem; text-align: left; margin-bottom: 10px; background: white; padding: 10px; border-radius: 8px;">
                        <b>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢</b><br>
                        ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <span style="color: var(--primary); font-weight: 800;">966-0-71965-5</span><br>
                        ‡∏ä‡∏∑‡πà‡∏≠: ‡∏ô‡∏≤‡∏¢ ‡∏®‡∏®‡∏¥‡∏ß‡∏±‡∏í‡∏ô‡πå ‡πÄ‡∏û‡∏ä‡∏£‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡πå
                    </div>
                    <input type="file" id="slipBank" accept="image/*" onchange="checkReady()" style="font-size: 0.8rem; width: 100%;">
                </div>

                <button id="confirmBtn" class="checkout-btn" onclick="processPayment()" disabled>
                    ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                </button>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZH_3IHmoKTtVO0LG6sNZ76Mf-3r-WZpH_xg1tFrb57wUrhUnZ1NnUT5iJZ8QXxDv_/exec';
        
        let currentProduct = { id: '', name: '', price: 0, icon: '', comment: '' };
        let quantity = 1;
        let selectedMethod = '';

        window.onload = function() {
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å sessionStorage
            const data = sessionStorage.getItem('selectedProduct');
            
            if (data) {
                const product = JSON.parse(data);
                currentProduct.id = product.id;
                currentProduct.name = product.name || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ NMRSW';
                currentProduct.price = parseInt(product.price) || 0;
                currentProduct.icon = product.icon || 'üì¶';
                currentProduct.comment = product.comment || '';

                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
                document.getElementById('mainProdTitle').textContent = currentProduct.name;
                document.getElementById('prodcomment').textContent = currentProduct.comment;
                
                const imgContainer = document.getElementById('imgContainer');
                if (currentProduct.icon.startsWith('http')) { 
                    imgContainer.innerHTML = `<img src="${currentProduct.icon}" alt="product">`;
                } else {
                    imgContainer.innerHTML = `<div style="font-size: 6rem;">${currentProduct.icon}</div>`;
                }
                
                updateTotal();
            } else {
                // ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏á‡πÜ) ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                window.location.href = 'index.html';
            }
        }

        function adjustQty(change) {
            if(quantity + change >= 1) { 
                quantity += change; 
                document.getElementById('quantityDisplay').textContent = quantity; 
                updateTotal(); 
            }
        }
  
        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        function updateTotal() {
            const total = currentProduct.price * quantity;
            document.getElementById('prodPrice').textContent = '‡∏ø' + total.toLocaleString();
        }

        function selectMethod(method) {
            selectedMethod = method;
            document.querySelectorAll('.pay-item').forEach(i => i.classList.remove('selected'));
            document.getElementById('pay-' + (method === 'qrcode' ? 'qr' : 'bank')).classList.add('selected');
            
            document.getElementById('sec-qrcode').style.display = method === 'qrcode' ? 'block' : 'none';
            document.getElementById('sec-banking').style.display = method === 'banking' ? 'block' : 'none';
            checkReady();
        }

        function checkReady() {
            const fields = ['firstName', 'lastName', 'stdClass', 'stdId'];
            const allFilled = fields.every(id => document.getElementById(id).value.trim() !== '');
            const slip = (selectedMethod === 'qrcode') ? document.getElementById('slipQR') : document.getElementById('slipBank');
            const hasSlip = selectedMethod && slip && slip.files.length > 0;

            // Updates Steps UI
            document.getElementById('st2').classList.toggle('active', allFilled);
            document.getElementById('st3').classList.toggle('active', hasSlip);

            document.getElementById('confirmBtn').disabled = !(allFilled && hasSlip);
        }

        async function processPayment() {
            const btn = document.getElementById('confirmBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
            btn.style.opacity = '0.7';
            btn.disabled = true; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≥

            const now = new Date();
            const recNum = 'REC-' + now.getTime();
            
            const formData = {
                receiptNum: recNum,
                fullName: document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value,
                studentClass: document.getElementById('stdClass').value,
                studentNo: document.getElementById('stdNo').value,
                studentId: document.getElementById('stdId').value,
                productName: currentProduct.name, // ‡∏™‡πà‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
                totalPrice: currentProduct.price * quantity,
                paymentMethod: selectedMethod === 'qrcode' ? 'QR Code' : '‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'
            };

            let fileData = null, fileName = null, mimeType = null;
            if(selectedMethod === 'qrcode' || selectedMethod === 'banking') {
                let fileInput = selectedMethod === 'qrcode' ? document.getElementById('slipQR') : document.getElementById('slipBank');
                if(fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    fileData = await getBase64(file);
                    fileName = file.name;
                    mimeType = file.type;
                }
            }

            try {
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ ...formData, file: fileData, filename: fileName, mimeType: mimeType })
                });
            } catch (error) { console.error(error); }

            showReceipt(recNum, now, formData);
            btn.innerHTML = originalText;
            btn.style.opacity = '1';
        }
    </script>
</body>
</html>
